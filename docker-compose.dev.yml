services:
  templ:
    image: readwillbe-templ:dev
    working_dir: /app
    volumes:
      - .:/app
      - go-mod-cache:/go/pkg/mod
    ports:
      - "7331:7331"
    command: >
      templ generate --watch
      --proxy="http://app:8080"
      --proxyport=7331
      --proxybind="0.0.0.0"
      --open-browser=false
    depends_on:
      app:
        condition: service_started
    networks:
      - devnet

  tailwind:
    image: readwillbe-frontend:dev
    working_dir: /app
    volumes:
      - .:/app
      - node-modules:/app/node_modules
    command: sh -c "bun install && bun run dev"
    networks:
      - devnet

  css-reload:
    image: readwillbe-app:dev
    working_dir: /app
    volumes:
      - ./static/css:/app/static/css:ro
    environment:
      - TEMPL_EXPERIMENT=rawgo
    command: >
      air
      --build.cmd "templ generate --notify-proxy"
      --build.bin "true"
      --build.include_ext "css"
      --build.include_dir "static/css"
      --build.exclude_dir ""
      --build.delay 100
    depends_on:
      - templ
      - tailwind
    networks:
      - devnet

  app:
    image: readwillbe-app:dev
    working_dir: /app
    volumes:
      - .:/app
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    environment:
      - READWILLBE_PORT=:8080
      - READWILLBE_DB_PATH=/app/data/readwillbe.db
      - READWILLBE_COOKIE_SECRET=dev-secret-change-me-in-prod
      - READWILLBE_SEED_DB=true
      - READWILLBE_ALLOW_SIGNUP=true
      - READWILLBE_LOG_LEVEL=debug
      - TEMPL_EXPERIMENT=rawgo
    command: sh -c "go mod download && mkdir -p tmp data && air"
    expose:
      - "8080"
    networks:
      - devnet

volumes:
  go-mod-cache:
  go-build-cache:
  node-modules:

networks:
  devnet:
    driver: bridge
