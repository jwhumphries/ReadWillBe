# CLAUDE.md

This file provides guidance to AI Agents when working with code in this repository.

## Build & Development Commands

**All builds, tests, and lints must run through Dagger. Never run these outside the Dagger environment.**

```bash
# Development
task dev-start      # Start dev environment with hot-reload at http://localhost:7331
task dev-stop       # Stop dev environment

# CI/Build (via Dagger)
task lint           # Run golangci-lint
task test           # Run Go tests
task typecheck      # TypeScript type checking
task build          # Build production Docker image
task build-assets   # Compile CSS (Tailwind) and React/TypeScript

# Formatting (local)
task fmt            # Format Go files
task templ-fmt      # Format Templ files
```

### Running a Single Test

Tests run inside Dagger containers. To run a specific test, modify `.dagger/main.go` temporarily or use the full test command:
```bash
dagger -m .dagger call test --source=.
```

## Architecture Overview

### Tech Stack
- **Backend**: Go 1.25, Echo framework, SQLite (via go-sqlite3/gorm)
- **Frontend**: Templ (Go HTML templates) + React 19 islands + Tailwind CSS v4 + DaisyUI 5
- **Build**: Dagger CI/CD, Docker, Bun (for JS/CSS tooling)
- **Deployment**: Kubernetes with Helm charts in `charts/readwillbe/`

### Request Flow

1. Echo router (`cmd/readwillbe/server.go`) handles HTTP requests
2. Handlers render Templ templates (`views/*.templ`) that produce HTML
3. React components mount as "islands" for interactive features
4. DaisyUI components in `internal/views/components/` provide reusable UI primitives

### React Islands Pattern

React components are embedded in Templ templates using a registry pattern:

```go
// In a .templ file - mount a React component with props
@React("ComponentName", map[string]interface{}{"prop": value})
```

The React registry (`assets/js/index.tsx`) maps component names to implementations. Components mount on `DOMContentLoaded` by finding `[data-react-component]` elements.

To add a new React component:
1. Create component in `assets/js/components/`
2. Register in `assets/js/index.tsx` components map
3. Use `@React("ComponentName", props)` in Templ templates

### DaisyUI Components

Pre-built DaisyUI components live in `internal/views/components/` as `.templ` files (generated by `gsi` CLI from "go ship it"). These wrap DaisyUI patterns with Go-friendly APIs:

```go
@components.Card(components.CardProps{Title: "...", Content: "..."})
```

### Data Models

Core types in `types/`:
- `User`: Authentication and user settings
- `Plan`: A collection of readings (e.g., "Bible Reading Plan 2025")
- `Reading`: Individual reading entries with date, content, and completion status
- `PushSubscription`: Browser push notification subscriptions

Readings support three date types: `day`, `week`, `month` - determining when they're due and how overdue status is calculated.

### Environment Configuration

All config via `READWILLBE_*` environment variables (loaded through Viper):
- `READWILLBE_COOKIE_SECRET` (required, 32+ chars)
- `READWILLBE_DB_PATH` - SQLite database path
- `READWILLBE_PORT` - Server port (default :8080)
- `GO_ENV=production` - Enables secure cookies, gzip, etc.

### Key Directories

```
cmd/readwillbe/     # Main application, HTTP handlers, business logic
views/              # Templ page templates
internal/views/components/  # DaisyUI component templates (gsi-generated)
assets/js/          # React components and TypeScript
types/              # Go domain models
.dagger/            # Dagger CI/CD module
charts/             # Helm chart for Kubernetes
static/             # Compiled assets (CSS, JS bundles) - generated, don't edit
```

### Development Environment

`task dev-start` runs a Docker container with:
- Air for Go hot-reload
- Templ proxy on port 7331 (use this in browser)
- Bun watchers for CSS and JS changes

The dev server auto-reloads on changes to `.go`, `.templ`, `.tsx`, and `.css` files.
